<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bun venit!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <!-- Mesaj de bun venit -->
        <div class="alert alert-primary text-center" role="alert">
            Bun venit, <strong>@username!</strong>
        </div>
        
        <div class="row">
            
            <!-- Container pentru utilizatori activi -->
            <div class="col-md-4">
                <h5>Utilizatori activi</h5>
                <ul id="active-users" class="list-unstyled">
                    <!-- Aici va fi lista utilizatorilor activi -->
                </ul>
            </div>

            <!-- Container pentru mesaje -->
            <div class="col-md-8">
                <h5>Chat</h5>
                <div class="mb-3">
                    <input type="text" class="form-control" onkeyup="sendMessage(event)"
                        placeholder="Scrie un mesaj către ceilalți">
                </div>
                <ul id="messages" class="list-unstyled"></ul>
            </div>
            
        </div>

    </div>
    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.onmessage = function (event) {
            console.log(`Received from server: ${event.data}`);

            const serverMessage = JSON.parse(event.data);

            switch (serverMessage.type) {
                case 'message':
                    const {token, message} = serverMessage;
                    // console.log(serverMessage.message);

                    const messagesList = document.getElementById('messages');
                    const newMessage = document.createElement('li');

                    const {username} = decodeJWTPayload(token);
                    // console.log(username);  
                    const isCurentUser = document.cookie.includes('token=' + token);

                    if (isCurentUser) {
                        newMessage.className = 'text-success text-end';
                    } else {
                        newMessage.className = 'text-secondary';
                    }
                    
                    newMessage.innerHTML = `<p><small class="text-muted"> <strong>${isCurentUser ? 'eu' : username}</strong></small><br/> ${message}</p>`;
                    messagesList.appendChild(newMessage);
                    break;

                case 'usernames':
                    const  {usernames} = serverMessage;
                    
                    const userList = document.getElementById('active-users'); 
                    userList.innerHTML = ''; 
                    // Populate the list with new usernames
                    usernames.forEach(username => {
                        const listItem = document.createElement('li'); 
                        listItem.textContent = username; 
                        userList.appendChild(listItem); 
                    });
                    
                    break;

                // Handle other message types as needed
                default:
                    console.warn('Unknown message type:', serverMessage.type);
                    break;
            }

        };
        
        ws.onopen = function () {
            console.log('WebSocket connection established');
        };

        sendMessage

        function sendMessage(event) {
            if (event.key === 'Enter') {
                const message = event.target.value;
                ws.send(message);
                event.target.value = ''; // Clear the input field
            }
        }

        function decodeJWTPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return '';

                const base64Url = parts[1];
                const base64 = base64Url
                    .replace(/-/g, '+')
                    .replace(/_/g, '/');

                const jsonPayload = decodeURIComponent(
                    atob(base64)
                        .split('')
                        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                        .join('')
                );

                return JSON.parse(jsonPayload);
            } catch (e) {
                return '';
            }
        }
    </script>
</body>

</html>
