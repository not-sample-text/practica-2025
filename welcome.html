<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bun venit!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="container py-5">
        <!-- Mesaj de bun venit -->
        <div class="alert alert-primary text-center" role="alert">
            Bun venit, <strong>@username!</strong>
        </div>

        <div class="mb-3">
            <input type="text" class="form-control" onkeyup="sendMessage(event)"
                placeholder="Scrie un mesaj către ceilalți">
        </div>
        <p>
        <ul id="messages" class="list-unstyled"></ul>
        <ul id="active-users" class="list-group"></ul>
        </p>

    </div>
    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = function (event) {
            console.log(`Received from server: ${event.data}`);
            const [token, message] = event.data.split('–');
            const messagesList = document.getElementById('messages');
            const usersList = document.getElementById('active-users');
            const newMessage = document.createElement('li');
            const newUser = document.createElement('li');
            const {username} = decodeJWTPayload(token);
            const isCurentUser = document.cookie.includes('token=' + token);
            if (isCurentUser) {
                newMessage.className = 'text-success text-end';
            } else {
                newMessage.className = 'text-secondary';
            }
            newMessage.innerHTML = `<p><small class="text-muted">${isCurentUser ? 'eu' : username}</small><br/> ${message}</p>`;
            newUser.innerHTML = `<p class="text-primary">${username}</p>`;
            // Add user to the active users list if not already present
            if (!Array.from(usersList.children).some(li => li.textContent === username)) {
                usersList.appendChild(newUser);
            }
            messagesList.appendChild(newMessage);
        };
        ws.onopen = function () {
            console.log('WebSocket connection established');
        };
        sendMessage
        function sendMessage(event) {
            if (event.key === 'Enter') {
                const message = event.target.value;
                ws.send(message);
                event.target.value = ''; // Clear the input field
            }
        }

        function decodeJWTPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return '';

                const base64Url = parts[1];
                const base64 = base64Url
                    .replace(/-/g, '+')
                    .replace(/_/g, '/');

                const jsonPayload = decodeURIComponent(
                    atob(base64)
                        .split('')
                        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                        .join('')
                );

                return JSON.parse(jsonPayload);
            } catch (e) {
                return '';
            }
        }
    </script>
</body>

</html>
